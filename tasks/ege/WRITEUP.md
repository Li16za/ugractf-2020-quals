# ЕГЭ: Write-up

Подключаемся и обнаруживаем, что нас просят ответить на некоторые вопросы о грамматике украинского языка:

```
Вас вітає електросистема оцінки знань в рамках підготовки до ЕГЭ!

Введіть код учасника: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

ЗАВДАННЯ 1. Частина 1/1337.
Каменища — вони що?
Ваш варіант (обидва, обидві, обоє):
```

Слово *оба* в украинском имеет три формы, зависящие от рода: *обидва* для мужского, *обидві* для женского и *обоє* для среднего. Дело за малым — распарсить ответ, достать слово, проанализировать его и ответить. Для этого можно было попробовать воспользоваться анализатором [pymorphy2](https://pymorphy2.readthedocs.io), например, а можно было поступить ещё проще — и просто скачать какой-нибудь словарь.

Я использовал словарь [ВЕСУМ](https://github.com/brown-uk/dict_uk), который с помощью утилиты `grep` отфильтровал¹ так, что остались лишь однозначно определяемые пары существительных и их множественных форм — так, например, слово *собака*, может относиться как к женскому, так и к мужскому роду:
```grep
$ grep собака dict.txt
4990911:собака noun:anim:m:v_naz   # m - masculine
4990918:  собака noun:anim:f:v_naz # f - feminine
```

---

Получившийся текстовый файл довольно тривиально использовать для того, чтобы написать простенький python-скрипт, который справится со всеми вопросами. Для такого удобно использовать библиотеку [pwntools](https://github.com/Gallopsled/pwntools):

```python
from pwn import *
import re
```

Откроем получившийся файл со словами, прочитаем его и запишем всё в словарик:
```python
def read_dict(file):
    file = open(file, 'r').read().split('\n')
    i = iter(file)
    return list(zip(i, i))


def parse_word(w):
    word, form = [x.split(':') for x in w]
    return {
        'singular': word[0].split()[0],
        'plural': form[0].strip().split()[0],
        'type': form[1],
        'gender': word[2]
    }

def load_dict(file):
    print("Loading dictionary...")
    return {a['plural']: a for a in map(parse_word, read_dict(file))}
```

Заведём ещё один словарик, для ответов.
```python
GRAM = {
    'm': 'обидва',
    'f': 'обидві',
    'n': 'обоє'
    }
```

Наладим подключение к серверу, проинициализируем словарик, и отошлём свой токен:

```python
r = remote('ege.q.2020.ugractf.ru', 17494) # адрес из условия задачи
d = load_dict('dict.txt')

r.recvuntil(':')
r.sendline(str(b"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"))
```

Будем читать ответ сервера построчно (то есть, пока не получим символ `\n`), поэтому заведём регулярное выражение, которым можно определить строку со словом и вытащить его из неё:

```python3
wordline = r"^([а-щьюяґєії\-']+) — вони"
```

Заводим цикл (в конце сервер оборвёт соединение, и мы словим исключение, которое этот цикл оборвёт, но обрабатывать его сейчас совсем не обязательно — работает же!):
```python
while True:
    inp = r.recvline('').decode('utf8')
    with_word = re.match(wordline, inp, re.I)
    print(inp) # смотрим, что пишут
```

Если текущая строчка — строчка со словом, достаём его из [группы](https://ru.wikipedia.org/wiki/Регулярные_выражения#Обратная_связь) нашего выражения и пытаемся сопоставить со словарём. В случае неудачи берём произвольное слово мужского рода — так у нас останется приличный шанс хотя бы угадать правильный ответ. Получив род существительного, берём ответ из `GRAM`, и отправялем его.
```python
    if with_word:
        word = d.get(with_word.group(1).lower(), 'інтерфейси')
        print(word)
        ans = GRAM.get(word.get('gender'))
        print('\n>', ans)
        r.sendline(ans)

```

В какой-то момент скрипт аварийно завершится, но, если нам повезёт, успеет выдасть заветный флаг:
```
Розминка успішно пройдена.

ЗАВДАННЯ 2.
Напишіть есе на тему «ugra_durnytsya_dribnitsya_c55508665747» (1000-1020 слів). Відправляти результат сюди не вимагається.

Успіхів! 
```

Флаг: **ugra_durnytsya_dribnitsya_c55508665747**.

---

1: участники сообщали, что не все неоднозначные слова были вычищены из словаря игры, однако мне кажется, что это не проблема, ведь игрокам давалось право на 30 ошибок, так что выиграть было вполне возможно — пусть даже и не с первого раза.
